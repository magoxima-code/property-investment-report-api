<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Property Report Builder</title>
<style>
  :root{--indigo:#4f46e5;--slate:#0f172a;--muted:#475569;--line:#e2e8f0;--green:#16a34a;--bg:#f8fafc}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--slate);margin:0;padding:24px}
  .container{max-width:1400px;margin:auto;display:block}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.04);margin-bottom:18px}
  .pad{padding:16px}
  h1{font-size:22px;margin:0 0 12px}
  h2{font-size:20px;margin:16px 0 10px}
  h3{font-size:16px;margin:0 0 8px;color:#0f172a}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
  .default-input{background:#f1f5f9;color:#64748b;border-color:#e2e8f0}
  .row{display:flex;gap:12px;align-items:flex-end}
  .muted{color:#64748b;font-size:12px}
  .metrics{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .metric{border:1px solid var(--line);border-radius:12px;padding:12px}
  .metric .lbl{font-size:12px;color:#64748b}.metric .val{font-size:20px;font-weight:600}
  table{width:100%;border-collapse:collapse;font-size:14px} th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
  th{color:#64748b;font-weight:600}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .cols2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .cols3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .cols4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .btn{background:var(--indigo);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.print{background:var(--green)}
  details{border:1px dashed var(--line);border-radius:12px;padding:10px}
  details summary{cursor:pointer;font-weight:600}
  @media (max-width:1024px){
    .metrics{grid-template-columns:repeat(2,1fr)}
    .cols4{grid-template-columns:1fr 1fr}
  }
  @media (max-width:640px){
    .metrics{grid-template-columns:1fr}
    .cols4{grid-template-columns:1fr}
  }
  @media print{
    body{padding:0;background:#fff}
    .card{border:0;box-shadow:none}
    .no-print{display:none!important}
  }
</style>
</head>
<body>

<div class="container">

  <!-- INPUTS -->
  <div class="card pad no-print">
    <h1>Property Report Builder</h1>
    <form id="f">
      <label>Property Address</label>
      <input id="addr" required placeholder="111/113 Cultural Park Blvd S, Cape Coral, FL 33990"/>

      <!-- Same level: Price, Units, Beds, Baths, Generate, Print -->
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <div style="flex:1 1 220px">
          <label>Purchase Price (USD)</label>
          <input id="price" placeholder="500000"/>
        </div>
        <div style="width:150px">
          <label>Units</label>
          <input id="units" placeholder="1" value="1"/>
        </div>
        <div style="width:150px">
          <label>Beds</label>
          <input id="beds" placeholder="2" value="2"/>
        </div>
        <div style="width:150px">
          <label>Baths</label>
          <input id="baths" placeholder="1" value="1"/>
        </div>
        <div>
          <button id="go" class="btn" type="submit">Generate</button>
        </div>
        <div>
          <button type="button" class="btn print" onclick="window.print()">Download / Print PDF</button>
        </div>
      </div>

      <!-- Collapsible defaults (editable, light gray) -->
      <details style="margin-top:12px">
        <summary>Defaults (click to edit)</summary>
        <div class="cols4" style="margin-top:10px">
          <div><label>Down %</label><input class="default-input" id="down" value="25"/></div>
          <div><label>Rate % (annual)</label><input class="default-input" id="rate" value="7.7"/></div>
          <div><label>Term (years)</label><input class="default-input" id="term" value="30"/></div>
          <div><label>Points %</label><input class="default-input" id="points" value="0"/></div>
          <div><label>Closing %</label><input class="default-input" id="closing" value="2"/></div>
          <div><label>Rehab ($)</label><input class="default-input" id="rehab" value="0"/></div>
          <div><label>Vacancy %</label><input class="default-input" id="vacancy" value="5"/></div>
          <div><label>Mgmt % of EGI</label><input class="default-input" id="mgmt" value="8"/></div>
          <div><label>Maint % of Gross</label><input class="default-input" id="maint" value="8"/></div>
          <div><label>Taxes ($/yr)</label><input class="default-input" id="taxes" value="0"/></div>
          <div><label>Insurance ($/yr)</label><input class="default-input" id="ins" value="0"/></div>
          <div><label>HOA ($/yr)</label><input class="default-input" id="hoa" value="0"/></div>
          <div><label>Utilities ($/yr)</label><input class="default-input" id="utils" value="0"/></div>
          <div><label>Other OpEx ($/yr)</label><input class="default-input" id="other" value="0"/></div>
          <div><label>Target Cap %</label><input class="default-input" id="targetcap" value="8"/></div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:28px">
            <input type="checkbox" id="selfmgmt"/>
            <label for="selfmgmt" style="margin:0;color:#64748b">Self-managed (sets management to 0%)</label>
          </div>
        </div>
      </details>

      <div class="muted" id="err" style="min-height:18px;margin-top:6px"></div>
    </form>
  </div>

  <!-- REPORT -->
  <div class="card pad" id="reportEmpty">
    <div class="muted">The full report will render here after you click <b>Generate</b>.</div>
  </div>
  <div class="card pad" id="report" style="display:none"></div>

</div>

<script>
const API = "/api/generate";
const DEBUG = new URLSearchParams(location.search).has("debug");

/* ---------- Helpers ---------- */
const fmtUSD = n => (n==null||isNaN(n)) ? "-" :
  Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
const pct = n => ((n||0)*100).toFixed(2)+"%";
const sum = a => a.reduce((s,x)=>s+(x||0),0);
const safeParseJSON = s => { try{ return s ? JSON.parse(s) : null; }catch{ return null; } };
const clean = s => (s??"").toString().trim();

/* ---------- Map JSON -> View model ---------- */
function mapFromSchema(x){
  const pctToDec = (n,def=0)=> typeof n==="number"? n/100 : def;
  const yearsToMonths = (y,def=30)=> typeof y==="number"? y*12 : def*12;

  const units = Array.isArray(x.units)&&x.units.length
    ? x.units.map((u,i)=>({ name: u.name || ("Unit " + (i+1)), rent: u.modeledRentMonthly ?? 0 }))
    : [{ name:"Subject Unit", rent: x.rents?.modeledMarketRentMonthly ?? 0 }];

  const comps = Array.isArray(x.rentComps)? x.rentComps.map(c=>({
    address: c.address, beds: (c.beds + "/" + c.baths),
    rent: c.askingRent ?? 0, dist: c.distanceMiles ?? null, condition: c.conditionNote || ""
  })) : [];

  return {
    address: clean(x?.subject?.address),
    prepared: new Date().toLocaleDateString(),
    snapshot: {
      propertyType: clean(x?.propertySnapshot?.propertyType),
      unitMix: clean(x?.propertySnapshot?.unitMix),
      beds: x?.propertySnapshot?.beds ?? null,
      baths: x?.propertySnapshot?.baths ?? null,
      livingSqft: x?.propertySnapshot?.livingSqft ?? null,
      yearBuilt: x?.propertySnapshot?.yearBuilt ?? null,
      lotSizeSqft: x?.propertySnapshot?.lotSizeSqft ?? null,
      hoa: { has: !!x?.propertySnapshot?.hoa?.hasHoa, annual: x?.propertySnapshot?.hoa?.annual ?? 0, name: clean(x?.propertySnapshot?.hoa?.name), notes: clean(x?.propertySnapshot?.hoa?.notes) },
      taxesAnnual: x?.propertySnapshot?.taxes?.annual ?? 0,
      taxesYear: x?.propertySnapshot?.taxes?.year ?? null,
      insAnnual: x?.propertySnapshot?.insurance?.dp3Annual ?? 0
    },
    purchasePrice: x?.purchase?.purchasePrice ?? 0,
    closingPct: x?.purchase?.closingCostPct ?? 0.02,
    pointsPctOfPrice: x?.purchase?.pointsPct ?? 0,
    rehabBudget: x?.purchase?.rehabBudget ?? 0,
    vacancyRate: pctToDec(x?.operatingAssumptions?.vacancyPct, 0.05),
    maintPctOfGross: pctToDec(x?.operatingAssumptions?.maintenancePctOfGrossRent, 0.08),
    mgmtPctOfEGI: pctToDec(x?.operatingAssumptions?.managementPctOfEGI, 0.08),
    utilsLL: x?.operatingAssumptions?.utilitiesLandlordPaidAnnual ?? 0,
    otherOpEx: x?.operatingAssumptions?.otherOpExAnnual ?? 0,
    selfManaged: !!x?.operatingAssumptions?.selfManaged,
    fin: {
      downPct: pctToDec(x?.financing?.downPaymentPct, 0.25),
      rateAnnual: pctToDec(x?.financing?.rateAnnualPct, 0.077),
      termMonths: yearsToMonths(x?.financing?.termYears, 30)
    },
    units, comps,
    rentBenchmark: x?.rents?.benchmarkMedian ?? null,
    modeledRent: x?.rents?.modeledMarketRentMonthly ?? (units[0]?.rent ?? null),
    targetCap: x?.reportMeta?.targetCapPct ? x.reportMeta.targetCapPct/100 : 0.08
  };
}

/* ---------- Calculations ---------- */
function compute(d){
  const monthlyRent = sum(d.units.map(u=>u.rent));
  const annualGSR = monthlyRent*12;
  const vacancy = annualGSR*d.vacancyRate;
  const egi = annualGSR - vacancy;
  const maintenance = annualGSR*d.maintPctOfGross;
  const management = egi*d.mgmtPctOfEGI * (d.selfManaged ? 0 : 1);
  const taxes = d.snapshot.taxesAnnual;
  const insurance = d.snapshot.insAnnual;
  const hoa = d.snapshot.hoa.annual || 0;
  const opEx = taxes + insurance + hoa + maintenance + management + d.utilsLL + d.otherOpEx;
  const noi = egi - opEx;
  const closing = d.purchasePrice * d.closingPct;
  const pointsCost = d.purchasePrice * d.pointsPctOfPrice;
  const totalCost = d.purchasePrice + closing;
  const loanAmount = d.purchasePrice * (1 - d.fin.downPct);
  const r = d.fin.rateAnnual/12, n = d.fin.termMonths;
  const monthlyPI = (loanAmount>0 && r>0) ? (loanAmount*r)/(1-Math.pow(1+r,-n)) : 0;
  const ads = monthlyPI*12;
  const dscr = ads ? (noi/ads) : 0;
  const cashInvested = d.purchasePrice*d.fin.downPct + closing + pointsCost + d.rehabBudget;
  const cashFlow = noi - ads;
  const cap = totalCost ? (noi/totalCost) : 0;
  const onePctRule = d.purchasePrice>0 ? (monthlyRent/d.purchasePrice) : 0;

  const sens = (rentMult=1, opExMult=1)=>{
    const gsr = annualGSR*rentMult, vac = gsr*d.vacancyRate, e = gsr-vac;
    const maint = gsr*d.maintPctOfGross, mgmt = e*d.mgmtPctOfEGI*(d.selfManaged?0:1);
    const opex = (taxes+insurance+hoa+d.utilsLL+d.otherOpEx)*opExMult + maint + mgmt;
    const n_ = e-opex, cap_ = totalCost?(n_/totalCost):0, dscr_=ads?(n_/ads):0, cf_=n_-ads;
    return { noi:n_, capRate:cap_, dscr:dscr_, cashFlow:cf_ };
  };

  const loaded = 1 + d.closingPct + d.pointsPctOfPrice;
  theMax = d.targetCap>0 ? (noi / d.targetCap) / loaded : null;

  return { monthlyRent, annualGSR, vacancy, egi, maintenance, management, opEx, noi, closing, pointsCost, totalCost, loanAmount, monthlyPI, ads, dscr, cashInvested, cashFlow, cap, onePctRule, sens, maxPurchaseAtTargetCap: theMax };
}

/* ---------- Render ---------- */
function render(d){
  const c = compute(d);
  const el = document.getElementById("report");
  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1 style="margin:0;font-size:22px">Investment Report — ${d.address}</h1>
        <div class="muted">Prepared: ${new Date().toLocaleDateString()}</div>
      </div>
      <button class="btn print no-print" onclick="window.print()">Download / Print PDF</button>
    </div>

    <div class="metrics" style="margin-top:12px">
      ${metric("Purchase Price", fmtUSD(d.purchasePrice))}
      ${metric("NOI (yr)", fmtUSD(c.noi))}
      ${metric("Cap Rate", pct(c.cap))}
      ${metric("Monthly P&I", fmtUSD(c.monthlyPI))}
      ${metric("DSCR", (c.dscr||0).toFixed(2)+"×")}
      ${metric("Cash Flow (yr)", fmtUSD(c.cashFlow))}
      ${metric("Total Cost", fmtUSD(c.totalCost))}
      ${metric("Modeled Rent (Total)", fmtUSD(c.monthlyRent)+"/mo")}
    </div>

    <h2>Property Snapshot</h2>
    <div class="grid3">
      ${mini("Type", d.snapshot.propertyType||"-")}
      ${mini("Unit Mix", d.snapshot.unitMix||"-")}
      ${mini("Beds/Baths", ([d.snapshot.beds,d.snapshot.baths].every(v=>v==null)?"-":(d.snapshot.beds+"/"+d.snapshot.baths)))}
      ${mini("Living Area", d.snapshot.livingSqft? (d.snapshot.livingSqft.toLocaleString()+" sqft") : "-")}
      ${mini("Year Built", d.snapshot.yearBuilt||"-")}
      ${mini("Lot Size", d.snapshot.lotSizeSqft? (d.snapshot.lotSizeSqft.toLocaleString()+" sqft") : "-")}
      ${mini("Taxes", fmtUSD(d.snapshot.taxesAnnual) + (d.snapshot.taxesYear?(" ("+d.snapshot.taxesYear+")"):""))}
      ${mini("Insurance (est.)", fmtUSD(d.snapshot.insAnnual))}
      ${mini("HOA", d.snapshot.hoa.has ? (fmtUSD(d.snapshot.hoa.annual)+"/yr") : "None")}
    </div>

    <h2>Units & Rents</h2>
    ${table([["Unit","Rent"]], d.units.map(u=>[u.name, fmtUSD(u.rent)+"/mo"]))}
  `;
  document.getElementById("reportEmpty").style.display="none";
  el.style.display="block";
}

function metric(label,val){ return '<div class="metric"><div class="lbl">'+label+'</div><div class="val">'+val+'</div></div>'; }
function mini(label,val){ return '<div class="card pad"><div class="lbl muted" style="margin-bottom:4px">'+label+'</div><div>'+(val||"-")+'</div></div>'; }
function table(headers, rows){
  const thead = (headers && headers.length) ? '<thead><tr>'+headers.map(h=>'<th>'+h+'</th>').join('')+'</tr></thead>' : '';
  const body = rows.map(r=>{
    const bold = r[2]===true;
    const cells = r.map((c,i)=> i===2 && c===true ? '' : '<td'+(bold?' style="font-weight:600"':'')+'>'+c+'</td>').join('');
    return '<tr>'+cells+'</tr>';
  }).join('');
  return '<table>'+thead+'<tbody>'+body+'</tbody></table>';
}

/* ---------- Submit ---------- */
const errBox = document.getElementById("err");
const btn = document.getElementById("go");
function numFromInput(v){ return v==null||v.trim()==="" ? undefined : Number(v.replace(/[$,\s]/g,"")); }

document.getElementById("f").addEventListener("submit", async (e)=>{
  e.preventDefault();
  errBox.textContent=""; btn.disabled = true; btn.textContent = "Generating…";

  try{
    const address = document.getElementById("addr").value.trim();
    if(!address){ errBox.textContent="Please enter an address."; btn.disabled=false; btn.textContent="Generate"; return; }

    const purchasePrice = numFromInput(document.getElementById("price").value);
    const units = numFromInput(document.getElementById("units").value) ?? 1;
    const beds = numFromInput(document.getElementById("beds").value) ?? 2;
    const baths = numFromInput(document.getElementById("baths").value) ?? 1;

    // Defaults panel (editable)
    const down = numFromInput(document.getElementById("down")?.value ?? "25") ?? 25;
    const rate = numFromInput(document.getElementById("rate")?.value ?? "7.7") ?? 7.7;
    const term = numFromInput(document.getElementById("term")?.value ?? "30") ?? 30;
    const points = numFromInput(document.getElementById("points")?.value ?? "0") ?? 0;
    const closing = numFromInput(document.getElementById("closing")?.value ?? "2") ?? 2;
    const rehab = numFromInput(document.getElementById("rehab")?.value ?? "0") ?? 0;
    const vacancy = numFromInput(document.getElementById("vacancy")?.value ?? "5") ?? 5;
    const mgmt = (document.getElementById("selfmgmt")?.checked ? 0 : (numFromInput(document.getElementById("mgmt")?.value ?? "8") ?? 8));
    const maint = numFromInput(document.getElementById("maint")?.value ?? "8") ?? 8;
    const taxes = numFromInput(document.getElementById("taxes")?.value ?? "0") ?? 0;
    const ins = numFromInput(document.getElementById("ins")?.value ?? "0") ?? 0;
    const hoa = numFromInput(document.getElementById("hoa")?.value ?? "0") ?? 0;
    const utils = numFromInput(document.getElementById("utils")?.value ?? "0") ?? 0;
    const other = numFromInput(document.getElementById("other")?.value ?? "0") ?? 0;
    const targetcap = numFromInput(document.getElementById("targetcap")?.value ?? "8") ?? 8;

    const overrides =
      ((document.getElementById("selfmgmt")?.checked) ? "self-managed; " : "") +
      "units " + units + "; beds " + beds + "; baths " + baths + "; " +
      "down " + down + "%; rate " + rate + "%; term " + term + "y; " +
      "points " + points + "%; closing " + closing + "%; rehab " + rehab + "; " +
      "vacancy " + vacancy + "%; management " + mgmt + "%; maintenance " + maint + "%; " +
      "taxes " + taxes + "; insurance " + ins + "; hoa " + hoa + "; utilities " + utils + "; other " + other + "; " +
      "targetcap " + targetcap + "%";

    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address, purchasePrice, overrides })
    });

    const raw = await r.text();
    if (!r.ok) {
      const maybe = safeParseJSON(raw);
      errBox.textContent = (maybe && (maybe.error?.message || maybe.error)) || ("API error " + r.status);
      if (DEBUG) console.error("API error:", raw);
      return;
    }

    const data = safeParseJSON(raw);
    if (!data || typeof data !== "object") { errBox.textContent = "API returned invalid format."; return; }
    const mapped = mapFromSchema(data);
    render(mapped);
  }catch(ex){
    errBox.textContent = String(ex?.message||ex);
    if (DEBUG) console.error(ex);
  }finally{
    btn.disabled = false; btn.textContent = "Generate";
  }
});
</script>

</body>
</html>







