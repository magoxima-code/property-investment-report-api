<script>
const API = "/api/generate";
const DEBUG = new URLSearchParams(location.search).has("debug");

// ---- Helpers ---------------------------------------------------------------
const fmtUSD = n => (n==null||isNaN(n)) ? "-" :
  Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
const pct = n => ((n||0)*100).toFixed(2)+"%";
const sum = a => a.reduce((s,x)=>s+(x||0),0);
const safeParseJSON = (s)=>{ try{ return s ? JSON.parse(s) : null; }catch{ return null; } };

function mapFromSchema(x){
  const pctToDec = (n,def=0)=> typeof n==="number"? n/100 : def;
  const yearsToMonths = (y,def=30)=> typeof y==="number"? y*12 : def*12;
  const units = Array.isArray(x.units)&&x.units.length? x.units.map(u=>({ name: u.name, rent: u.modeledRentMonthly ?? 0 })) : [{ name:"Unit A", rent:0 }];
  const comps = Array.isArray(x.rentComps)? x.rentComps.map(c=>({ label: c.address, rent: c.askingRent ?? 0, beds: `${c.beds}/${c.baths}`, dist: c.distanceMiles ?? 0, condition: c.conditionNote })) : [];
  return {
    address: x.subject?.address ?? "",
    purchasePrice: x.purchase?.purchasePrice ?? 0,
    closingPct: x.purchase?.closingCostPct ?? 0.02,
    pointsOnLoanPctOfPrice: x.purchase?.pointsPct ?? 0,
    vacancyRate: pctToDec(x.operatingAssumptions?.vacancyPct, 0.05),
    maintPctOfGrossRent: pctToDec(x.operatingAssumptions?.maintenancePctOfGrossRent, 0.08),
    mgmtPctOfEGI: pctToDec(x.operatingAssumptions?.managementPctOfEGI, 0.08),
    insuranceAnnual: x.propertySnapshot?.insurance?.dp3Annual ?? 0,
    taxesAnnual: x.propertySnapshot?.taxes?.annual ?? 0,
    hoaAnnual: x.propertySnapshot?.hoa?.annual ?? 0,
    utilsAnnualLL: x.operatingAssumptions?.utilitiesLandlordPaidAnnual ?? 0,
    otherAnnual: x.operatingAssumptions?.otherOpExAnnual ?? 0,
    units,
    financing: {
      downPct: pctToDec(x.financing?.downPaymentPct, 0.25),
      rateAnnual: pctToDec(x.financing?.rateAnnualPct, 0.077),
      termMonths: yearsToMonths(x.financing?.termYears, 30),
    },
    comps
  };
}

function withDefaults(x){
  return {
    address: x.address || "",
    purchasePrice: x.purchasePrice ?? 0,
    closingPct: x.closingPct ?? 0.03,
    pointsOnLoanPctOfPrice: x.pointsOnLoanPctOfPrice ?? 0.0075,
    vacancyRate: x.vacancyRate ?? 0.05,
    maintPctOfGrossRent: x.maintPctOfGrossRent ?? 0.08,
    mgmtPctOfEGI: x.mgmtPctOfEGI ?? 0.08,
    insuranceAnnual: x.insuranceAnnual ?? 0,
    taxesAnnual: x.taxesAnnual ?? 0,
    otherAnnual: x.otherAnnual ?? 0,
    hoaAnnual: x.hoaAnnual ?? 0,
    utilsAnnualLL: x.utilsAnnualLL ?? 0,
    units: Array.isArray(x.units)&&x.units.length? x.units : [{ name:"Unit A", rent:0 }],
    financing: { downPct: x.financing?.downPct ?? 0.25, rateAnnual: x.financing?.rateAnnual ?? 0.077, termMonths: x.financing?.termMonths ?? 360 },
    comps: x.comps ?? [],
  };
}

function renderReport(data){
  const d = withDefaults(data);
  const monthlyRent = sum(d.units.map(u=>u.rent));
  const annualGSR = monthlyRent*12;
  const vacancy = annualGSR*d.vacancyRate;
  const egi = annualGSR - vacancy;
  const maint = annualGSR*d.maintPctOfGrossRent;
  const mgmt = egi*d.mgmtPctOfEGI;
  const opEx = d.taxesAnnual + d.insuranceAnnual + d.hoaAnnual + maint + mgmt + d.utilsAnnualLL + d.otherAnnual;
  const noi = egi - opEx;
  const closingCost = d.purchasePrice * d.closingPct;
  const totalCost = d.purchasePrice + closingCost;
  const loanAmount = d.purchasePrice * (1 - d.financing.downPct);
  const r = d.financing.rateAnnual/12;
  const n = d.financing.termMonths;
  const monthlyPI = (loanAmount>0 && r>0) ? (loanAmount*r)/(1-Math.pow(1+r,-n)) : 0;
  const annualDebtService = monthlyPI*12;
  const dscr = annualDebtService ? (noi/annualDebtService) : 0;
  const pointsCost = d.purchasePrice * d.pointsOnLoanPctOfPrice;
  const cashInvested = d.purchasePrice*d.financing.downPct + closingCost + pointsCost;
  const cashFlow = noi - annualDebtService;
  const capRate = totalCost ? (noi/totalCost) : 0;

  const el = document.getElementById("report");
  el.innerHTML = `
    <div class="row">
      <div>
        <h1>Investment Report — ${d.address}</h1>
        <div class="muted">Prepared: ${new Date().toLocaleDateString()}</div>
      </div>
      <button class="print" onclick="window.print()">Download / Print PDF</button>
    </div>
    <div class="metrics" style="margin-top:12px">
      ${metric("Purchase Price", fmtUSD(d.purchasePrice))}
      ${metric("NOI (yr)", fmtUSD(noi))}
      ${metric("Cap Rate", pct(capRate))}
      ${metric("Monthly P&I", fmtUSD(monthlyPI))}
      ${metric("DSCR", (dscr||0).toFixed(2)+"×")}
      ${metric("Cash Flow (yr)", fmtUSD(cashFlow))}
      ${metric("Total Cost", fmtUSD(totalCost))}
      ${metric("Modeled Rent (Total)", fmtUSD(monthlyRent)+"/mo")}
    </div>
    ${unitsTable(d.units)}
  `;
  document.getElementById("reportEmpty").style.display="none";
  el.style.display="block";
}

function metric(label,val){ return `<div class="metric"><div class="lbl">${label}</div><div class="val">${val}</div></div>`; }
function unitsTable(units){ return `<h2 style="margin-top:18px">Units & Rents</h2>
  <table><thead><tr><th>Unit</th><th style="text-align:right">Rent</th></tr></thead><tbody>${
    units.map(u=>`<tr><td>${u.name}</td><td style="text-align:right">${fmtUSD(u.rent)}/mo</td></tr>`).join("")
  }</tbody></table>`; }

// ---- Form submit -----------------------------------------------------------
const errBox = document.getElementById("err");
const btn = document.getElementById("go");

document.getElementById("f").addEventListener("submit", async (e)=>{
  e.preventDefault();
  errBox.textContent=""; btn.disabled = true; btn.textContent = "Generating…";
  const address = document.getElementById("addr").value.trim();
  const purchasePrice = Number((document.getElementById("price").value||"").replace(/[$,\\s]/g,"")) || undefined;
  const overrides = document.getElementById("over").value.trim() || undefined;

  try{
    // read as text first, then parse to be extra-robust
    const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ address, purchasePrice, overrides }) });
    const raw = await r.text();
    if (!r.ok) {
      let err = safeParseJSON(raw)?.error || `API error ${r.status}`;
      errBox.textContent = err;
      if (DEBUG) console.error("API error:", raw);
      return;
    }
    let data = safeParseJSON(raw) ?? raw;         // parsed object or raw string
    if (DEBUG) console.log("API raw:", raw, "parsed:", data);

    // If backend sent the schema object, great. If it was stringified JSON, parse handled it.
    if (!data || typeof data !== "object") {
      errBox.textContent = "Invalid response format from API.";
      return;
    }
    const mapped = mapFromSchema(data);
    renderReport(mapped);
  }catch(ex){
    errBox.textContent = String(ex?.message||ex);
    if (DEBUG) console.error(ex);
  }finally{
    btn.disabled = false; btn.textContent = "Generate";
  }
});
</script>
